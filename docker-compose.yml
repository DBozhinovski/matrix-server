version: "3.8"

services:
  # --- 1. The Database ---
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=synapse
      - POSTGRES_PASSWORD=${DB_PASSWORD} # Defined in Coolify
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - matrix-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U synapse"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- 2. The Homeserver ---
  synapse:
    image: matrixdotorg/synapse:latest
    restart: unless-stopped
    environment:
      - SYNAPSE_SERVER_NAME=${MATRIX_DOMAIN} # Defined in Coolify
      - SYNAPSE_REPORT_STATS=no
    volumes:
      - synapse_data:/data
      # Mount ALL bridge volumes so Synapse can read their registration files
      - discord_data:/bridges/discord
      - telegram_data:/bridges/telegram
      - heisenbridge_data:/bridges/heisenbridge
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - matrix-net

  # --- 3. Discord Bridge ---
  mautrix-discord:
    image: dock.mau.dev/mautrix/discord:latest
    restart: unless-stopped
    environment:
      # Override config to use Postgres automatically
      - MAUTRIX_DISCORD_APPSERVICE_DATABASE=postgres://synapse:${DB_PASSWORD}@postgres/discord?sslmode=disable
    volumes:
      - discord_data:/data
    networks:
      - matrix-net

  # --- 4. Telegram Bridge ---
  mautrix-telegram:
    image: dock.mau.dev/mautrix/telegram:latest
    restart: unless-stopped
    environment:
      # Override config to use Postgres automatically
      - MAUTRIX_TELEGRAM_APPSERVICE_DATABASE=postgres://synapse:${DB_PASSWORD}@postgres/telegram?sslmode=disable
    volumes:
      - telegram_data:/data
    networks:
      - matrix-net

  # --- 5. IRC Bridge (Heisenbridge) ---
  heisenbridge:
    image: hifi/heisenbridge:latest
    restart: unless-stopped
    volumes:
      - heisenbridge_data:/data
    networks:
      - matrix-net
    # Heisenbridge uses an internal SQLite DB by default, which is fine for IRC.

volumes:
  db_data:
  synapse_data:
  discord_data:
  telegram_data:
  heisenbridge_data:

networks:
  matrix-net:
    driver: bridge
