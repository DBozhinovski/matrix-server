version: "3.8"

services:
  # Database
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=synapse
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - matrix-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U synapse"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Homeserver
  synapse:
    image: matrixdotorg/synapse:latest
    restart: unless-stopped
    environment:
      - SYNAPSE_SERVER_NAME=${MATRIX_DOMAIN}
      - SYNAPSE_REPORT_STATS=no
    volumes:
      - synapse_data:/data
      - discord_data:/bridges/discord
      - telegram_data:/bridges/telegram
      - heisenbridge_data:/bridges/heisenbridge
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - matrix-net

  # Discord Bridge
  mautrix-discord:
    image: dock.mau.dev/mautrix/discord:latest
    restart: unless-stopped
    environment:
      - MAUTRIX_DISCORD_APPSERVICE_DATABASE=postgres://synapse:${DB_PASSWORD}@postgres/discord?sslmode=disable
    volumes:
      - discord_data:/data
    networks:
      - matrix-net

  # Telegram Bridge
  mautrix-telegram:
    image: dock.mau.dev/mautrix/telegram:latest
    restart: unless-stopped
    environment:
      - MAUTRIX_TELEGRAM_APPSERVICE_DATABASE=postgres://synapse:${DB_PASSWORD}@postgres/telegram?sslmode=disable
    volumes:
      - telegram_data:/data
    networks:
      - matrix-net

  # IRC Bridge (FIXED COMMAND ADDED)
  heisenbridge:
    image: hif1/heisenbridge:latest
    restart: unless-stopped
    command:
      [
        "python3",
        "-m",
        "heisenbridge",
        "-c",
        "/data/registration.yaml",
        "-l",
        "0.0.0.0",
        "-p",
        "9898",
        "http://synapse:8008",
      ]
    volumes:
      - heisenbridge_data:/data
    networks:
      - matrix-net

volumes:
  db_data:
  synapse_data:
  discord_data:
  telegram_data:
  heisenbridge_data:

networks:
  matrix-net:
    driver: bridge
